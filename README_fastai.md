# SensiCut Fast.ai ç‰ˆæœ¬è®­ç»ƒè„šæœ¬

è¿™æ˜¯ä½¿ç”¨ fast.ai æ¡†æ¶é‡å†™çš„ SensiCut ææ–™è¯†åˆ«è®­ç»ƒè„šæœ¬ã€‚ç›¸æ¯”åŸå§‹çš„ PyTorch ç‰ˆæœ¬ï¼Œfast.ai ç‰ˆæœ¬æä¾›äº†æ›´ç®€æ´çš„ API å’Œæ›´å¤šå†…ç½®åŠŸèƒ½ã€‚

## æ–‡ä»¶è¯´æ˜

- `train_sensicut_fastai.py`: ä¸»è¦çš„è®­ç»ƒè„šæœ¬
- `predict_fastai.py`: é¢„æµ‹è„šæœ¬ï¼Œç”¨äºä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œæ¨ç†
- `requirements_fastai.txt`: ä¾èµ–åŒ…åˆ—è¡¨
- `README_fastai.md`: ä½¿ç”¨è¯´æ˜ï¼ˆæœ¬æ–‡ä»¶ï¼‰

## å®‰è£…ä¾èµ–

```bash
pip install -r requirements_fastai.txt
```

## ä¸»è¦æ”¹è¿›

### ç›¸æ¯”åŸå§‹ PyTorch ç‰ˆæœ¬çš„ä¼˜åŠ¿ï¼š

1. **æ›´ç®€æ´çš„ä»£ç **: fast.ai æä¾›äº†é«˜çº§APIï¼Œå¤§å¤§å‡å°‘äº†ä»£ç é‡
2. **å†…ç½®æ•°æ®å¢å¼º**: ä½¿ç”¨ `aug_transforms()` è‡ªåŠ¨åº”ç”¨å¤šç§æ•°æ®å¢å¼ºæŠ€æœ¯
3. **è‡ªåŠ¨å­¦ä¹ ç‡è°ƒåº¦**: ä½¿ç”¨ `fit_one_cycle()` å®ç°ä¸€å‘¨æœŸå­¦ä¹ ç‡è°ƒåº¦
4. **åˆ†é˜¶æ®µè®­ç»ƒ**: è‡ªåŠ¨å®ç°å†»ç»“-è§£å†»çš„è¿ç§»å­¦ä¹ ç­–ç•¥
5. **å†…ç½®å¯è§†åŒ–**: æä¾›ä¸°å¯Œçš„å¯è§†åŒ–å·¥å…·ï¼ˆæŸå¤±å›¾ã€æ··æ·†çŸ©é˜µç­‰ï¼‰
6. **æ›´å¥½çš„æ¨¡å‹è§£é‡Š**: å†…ç½®æ¨¡å‹è§£é‡Šå·¥å…·ï¼Œå¸®åŠ©ç†è§£æ¨¡å‹é¢„æµ‹
7. **æ›´æ™ºèƒ½çš„å­¦ä¹ ç‡è°ƒåº¦**: ä½¿ç”¨ä¸€å‘¨æœŸå­¦ä¹ ç‡è°ƒåº¦æ›¿ä»£å›ºå®šå­¦ä¹ ç‡

### ä¿æŒä¸å˜çš„å‚æ•°ï¼š

- æ‰¹å¤§å°: 32 (é€‚åˆ M2 èŠ¯ç‰‡)
- è®­ç»ƒè½®æ•°: 20
- å­¦ä¹ ç‡: 0.003
- æ•°æ®é›†åˆ†å‰²: 80% è®­ç»ƒï¼Œ20% éªŒè¯
- æ¨¡å‹æ¶æ„: ResNet-50
- ä¼˜åŒ–å™¨: Adam (æ˜¾å¼è®¾ç½®ä»¥ä¿æŒä¸åŸç‰ˆä¸€è‡´)

## ä½¿ç”¨æ–¹æ³•

### 1. è®­ç»ƒæ¨¡å‹

```bash
python train_sensicut_fastai.py
```

è®­ç»ƒå®Œæˆåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š
- `sensicut_resnet50_fastai.pkl`: å¯¼å‡ºçš„æ¨¡å‹æ–‡ä»¶ï¼ˆç”¨äºæ¨ç†ï¼‰
- `class_names_fastai.json`: ç±»åˆ«åç§°æ–‡ä»¶
- `training_loss_fastai.png`: è®­ç»ƒæŸå¤±å›¾
- `confusion_matrix_fastai.png`: æ··æ·†çŸ©é˜µ
- `top_losses_fastai.png`: é¢„æµ‹é”™è¯¯æœ€å¤šçš„æ ·æœ¬
- `sample_images_fastai.png`: è®­ç»ƒæ ·æœ¬é¢„è§ˆ

### 2. ä½¿ç”¨æ¨¡å‹è¿›è¡Œé¢„æµ‹

```bash
python predict_fastai.py
```

æˆ–è€…åœ¨ Python ä»£ç ä¸­ä½¿ç”¨ï¼š

```python
from predict_fastai import SensiCutPredictor

# åˆå§‹åŒ–é¢„æµ‹å™¨
predictor = SensiCutPredictor()

# é¢„æµ‹å•å¼ å›¾ç‰‡
result = predictor.predict_single_image("path/to/image.jpg", top_k=5)
print(f"é¢„æµ‹ç»“æœ: {result['predicted_class']}")
print(f"ç½®ä¿¡åº¦: {result['confidence']:.3f}")

# æ‰¹é‡é¢„æµ‹
image_paths = ["image1.jpg", "image2.jpg", "image3.jpg"]
results = predictor.predict_batch(image_paths)

# è¯„ä¼°æµ‹è¯•æ–‡ä»¶å¤¹
evaluation = predictor.evaluate_test_folder("test_images/")
```

## ä¼˜åŒ–å™¨è¯´æ˜

**é‡è¦**: åŸæœ¬ fast.ai é»˜è®¤ä½¿ç”¨ SGD ä¼˜åŒ–å™¨ï¼Œä½†ä¸ºäº†ä¿æŒä¸åŸç‰ˆä¸€è‡´ï¼Œæˆ‘ä»¬æ˜¾å¼è®¾ç½®äº† Adam ä¼˜åŒ–å™¨ï¼š

```python
learner = vision_learner(
    dls,
    arch,
    metrics=[accuracy],
    pretrained=True,
    opt_func=Adam  # ä½¿ç”¨Adamä¼˜åŒ–å™¨ä»¥ä¿æŒä¸åŸç‰ˆä¸€è‡´
)
```

## è®­ç»ƒæµç¨‹

fast.ai ç‰ˆæœ¬é‡‡ç”¨äº†æ›´å…ˆè¿›çš„è®­ç»ƒç­–ç•¥ï¼š

1. **ç¬¬ä¸€é˜¶æ®µ (5 ä¸ª epoch)**: 
   - å†»ç»“é¢„è®­ç»ƒçš„ ResNet-50 å±‚
   - åªè®­ç»ƒæœ€åçš„åˆ†ç±»å¤´
   - ä½¿ç”¨è¾ƒé«˜çš„å­¦ä¹ ç‡ (0.003)

2. **ç¬¬äºŒé˜¶æ®µ (15 ä¸ª epoch)**:
   - è§£å†»æ‰€æœ‰å±‚è¿›è¡Œå¾®è°ƒ
   - ä½¿ç”¨è¾ƒä½çš„å­¦ä¹ ç‡ (0.0003)
   - åº”ç”¨ä¸€å‘¨æœŸå­¦ä¹ ç‡è°ƒåº¦

## æ•°æ®å¢å¼º

fast.ai ç‰ˆæœ¬ä½¿ç”¨äº†æ›´ä¸°å¯Œçš„æ•°æ®å¢å¼ºæŠ€æœ¯ï¼š

- éšæœºæ°´å¹³ç¿»è½¬
- éšæœºæ—‹è½¬ (Â±10Â°)
- éšæœºç¼©æ”¾ (0.8-1.2å€)
- éšæœºäº®åº¦å’Œå¯¹æ¯”åº¦è°ƒæ•´ (Â±30%)
- è‡ªåŠ¨åº”ç”¨ ImageNet æ ‡å‡†åŒ–

## æ¨¡å‹è¯„ä¼°

è®­ç»ƒå®Œæˆåï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š

1. **è®­ç»ƒå†å²å›¾**: æ˜¾ç¤ºè®­ç»ƒå’ŒéªŒè¯æŸå¤±çš„å˜åŒ–
2. **æ··æ·†çŸ©é˜µ**: æ˜¾ç¤ºå„ç±»åˆ«çš„é¢„æµ‹å‡†ç¡®æ€§
3. **é¢„æµ‹é”™è¯¯åˆ†æ**: æ˜¾ç¤ºé¢„æµ‹é”™è¯¯æœ€å¤šçš„æ ·æœ¬
4. **åˆ†ç±»æŠ¥å‘Š**: æ¯ä¸ªç±»åˆ«çš„ç²¾ç¡®åº¦ã€å¬å›ç‡å’ŒF1åˆ†æ•°

## è®¾å¤‡æ”¯æŒ

æ”¯æŒå¤šç§è®¡ç®—è®¾å¤‡ï¼š
- âœ… NVIDIA GPU (CUDA)
- âœ… Apple Silicon GPU (MPS)
- âœ… CPU

## æ€§èƒ½ä¼˜åŒ–

ä¸ºäº†åœ¨ä¸åŒè®¾å¤‡ä¸Šè·å¾—æœ€ä½³æ€§èƒ½ï¼š

- **M2 èŠ¯ç‰‡**: ä½¿ç”¨è¾ƒå°çš„æ‰¹å¤§å° (32) å’Œè¾ƒå°‘çš„ worker çº¿ç¨‹ (2)
- **CUDA GPU**: å¯ä»¥ä½¿ç”¨æ›´å¤§çš„æ‰¹å¤§å°å’Œæ›´å¤šçš„ worker çº¿ç¨‹
- **CPU**: è‡ªåŠ¨é™ä½æ‰¹å¤§å°ä»¥é€‚åº”å†…å­˜é™åˆ¶

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜ï¼š

1. **å†…å­˜ä¸è¶³**: 
   - å‡å°‘æ‰¹å¤§å° (BATCH_SIZE)
   - å‡å°‘ worker çº¿ç¨‹æ•°é‡

2. **è®­ç»ƒé€Ÿåº¦æ…¢**:
   - æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº† GPU åŠ é€Ÿ
   - åœ¨ M2 èŠ¯ç‰‡ä¸Šç¡®ä¿ä½¿ç”¨äº† MPS åç«¯

3. **æ¨¡å‹åŠ è½½å¤±è´¥**:
   - ç¡®ä¿ `sensicut_resnet50_fastai.pkl` æ–‡ä»¶å­˜åœ¨
   - æ£€æŸ¥ fast.ai ç‰ˆæœ¬æ˜¯å¦å…¼å®¹

### è°ƒè¯•æŠ€å·§ï¼š

```python
# æŸ¥çœ‹æ•°æ®åŠ è½½å™¨
dls.show_batch()

# æ£€æŸ¥æ¨¡å‹æ¶æ„
learner.model

# æŸ¥çœ‹å­¦ä¹ ç‡å»ºè®®
learner.lr_find()

# æŸ¥çœ‹è®­ç»ƒè®°å½•
learner.recorder.plot_loss()
```

## è¿›é˜¶ä½¿ç”¨

### è‡ªå®šä¹‰æ•°æ®å¢å¼ºï¼š

```python
# åœ¨ create_dataloaders å‡½æ•°ä¸­ä¿®æ”¹
batch_tfms=[
    *aug_transforms(
        do_flip=True,
        flip_vert=False,
        max_rotate=15.0,  # å¢åŠ æ—‹è½¬è§’åº¦
        max_zoom=1.5,     # å¢åŠ ç¼©æ”¾èŒƒå›´
        max_lighting=0.4, # å¢åŠ å…‰ç…§å˜åŒ–
        # æ·»åŠ æ›´å¤šå¢å¼º...
    ),
    Normalize.from_stats(*imagenet_stats)
]
```

### ä½¿ç”¨ä¸åŒçš„æ¨¡å‹æ¶æ„ï¼š

```python
# åœ¨ create_model å‡½æ•°ä¸­ä¿®æ”¹
learner = vision_learner(
    dls,
    resnet101,  # ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹
    metrics=[accuracy],
    pretrained=True
)
```

## æ€»ç»“

fast.ai ç‰ˆæœ¬ç›¸æ¯”åŸå§‹ PyTorch ç‰ˆæœ¬æä¾›äº†ï¼š

- ğŸ“¦ æ›´ç®€æ´çš„ä»£ç ç»“æ„
- ğŸš€ æ›´å¿«çš„å¼€å‘é€Ÿåº¦
- ğŸ“Š æ›´ä¸°å¯Œçš„å¯è§†åŒ–å·¥å…·
- ğŸ”§ æ›´æ™ºèƒ½çš„é»˜è®¤è®¾ç½®
- ğŸ¯ æ›´å¥½çš„è®­ç»ƒç­–ç•¥

é€‚åˆå¿«é€ŸåŸå‹å¼€å‘å’Œå®éªŒï¼ŒåŒæ—¶ä¿æŒäº†ä¸åŸç‰ˆæœ¬ç›¸åŒçš„æ ¸å¿ƒåŠŸèƒ½å’Œæ€§èƒ½ã€‚ 